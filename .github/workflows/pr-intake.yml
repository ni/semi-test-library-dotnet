name: pr-intake

on:
    pull_request:
        branches: 
        - main
        - 'releases/**'     
        paths:
        - 'Examples/**'
        - 'SemiconductorTestLibrary.Abstractions/**'
        - 'SemiconductorTestLibrary.Extensions/**'
        - 'SemiconductorTestLibrary.TestStandSteps/**'
        - 'TestAssets/**'
        - '.github/**'

env:
    GitHub_Repo_Name: "semi-test-library-dotnet"
    PR_Number: "#${{ github.event.number }}"

jobs:
  wait-for-pr-build-workflow:
    runs-on: ubuntu-latest
    # environment: gh-action-testing # Temporary commenting out the environment to test the workflow without it.
    steps:
      # Before fetching the run ID, we need to wait for the PR Build Workflow run to start as it uses in_progress type of workflow_run event.
      - name: Wait for PR Build Workflow to Start
        run: sleep 10

      - name: Get PR_Build Workflow Run ID
        id: get_runid
        run: |
          WORKFLOW_NAME="pr-build"

          WORKFLOW_ID=$(curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/workflows" \
                             | jq -r ".workflows[] | select(.name == \"$WORKFLOW_NAME\") | .id")

          # Fetch runs of Workflow
          response=$(curl -w "%{http_code}" "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/workflows/$WORKFLOW_ID/runs" \
                   -o runs.json)

          if [ "$response" -ne 200 ]; then
            echo "Failed to fetch runs of Workflow - $WORKFLOW_NAME. Exiting."
            exit 1
          fi

          run_id=$(jq -r '.workflow_runs[] | select(.display_title | contains(${{env.PR_Number}})) | .id' runs.json)
          
          echo "Fetched run_id: $run_id"
          echo "::set-output name=run_id::$run_id"

      - name: Wait for Specific Workflow Run to Complete
        id: wait
        run: |
          SPECIFIC_RUN_ID=${{ steps.get_runid.outputs.run_id }}
          TIMEOUT=3600 # 1 hour
          INTERVAL=240 # 4 minutes
          ELAPSED=0
          while true; do
            # Check the status of the specific run
            STATUS=$(curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/runs/$SPECIFIC_RUN_ID" \
                          | jq -r '.status')

            echo "Current Status: $STATUS"
            if [[ "$STATUS" == "completed" ]]; then
              break
            fi

            if [[ "$ELAPSED" -ge "$TIMEOUT" ]]; then
              echo "Error: Timeout reached while waiting for workflow to complete."
              exit 1
            fi

            echo "Waiting for Workflow to complete..."
            sleep $INTERVAL # Wait before polling again
            ELAPSED=$((ELAPSED+INTERVAL))
          done

      - name: Check Conclusion of Workflow
        run: |
          SPECIFIC_RUN_ID=${{ steps.get_runid.outputs.run_id }}
          CONCLUSION=$(curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/runs/$SPECIFIC_RUN_ID" \
                            | jq -r '.conclusion')

          echo "Workflow Conclusion: $CONCLUSION"
          
          if [ "$CONCLUSION" == "success" ]; then
            echo "Workflow succeeded."
          else
            echo "Workflow failed or was canceled. Exiting."
            exit 1 
          fi