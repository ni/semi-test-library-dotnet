name: pr-intake

on:
    pull_request:
        branches: 
        - main
        - 'releases/**'     
        paths:
        - 'Examples/**'
        - 'SemiconductorTestLibrary.Abstractions/**'
        - 'SemiconductorTestLibrary.Extensions/**'
        - 'SemiconductorTestLibrary.TestStandSteps/**'
        - 'TestAssets/**'
        - '.github/**'

env:
    GitHub_Repo_Name: "semi-test-library-dotnet"
    PR_Number: "${{ github.event.number }}"

jobs:
  wait-for-pr-build-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR_Build Workflow Run ID
        id: get_runid
        run: |
          WORKFLOW_ID=126108688 # ID of pr-build workflow

          # Fetch runs of Workflow
          curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/workflows/$WORKFLOW_ID/runs" \
               -o runs.json

          run_id=$(jq -r '.workflow_runs[] | select(.display_title | contains(${{env.PR_Number}})) | .id' runs.json)
          
          echo "Fetched run_id: $run_id"
          echo "::set-output name=run_id::$run_id"

      - name: Wait for Specific Workflow Run to Complete
        id: wait
        run: |
          SPECIFIC_RUN_ID=${{ steps.get_runid.outputs.run_id }}
          while true; do
            # Check the status of the specific run
            STATUS=$(curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/runs/$SPECIFIC_RUN_ID" \
                           | jq -r '.status')

            echo "Current Status: $STATUS"
            if [[ "$STATUS" == "completed" ]]; then
              break
            fi

            echo "Waiting for Workflow to complete..."
            sleep 10 # Wait before polling again
          done

      - name: Check Conclusion of Workflow
        run: |
          SPECIFIC_RUN_ID=${{ steps.get_runid.outputs.run_id }}
          CONCLUSION=$(curl "https://api.github.com/repos/ni/${{ env.GitHub_Repo_Name }}/actions/runs/$SPECIFIC_RUN_ID" \
                          | jq -r '.conclusion')

          echo "Workflow Conclusion: $CONCLUSION"
          
          if [ "$CONCLUSION" == "success" ]; then
            echo "Workflow succeeded."
          else
            echo "Workflow failed or was canceled. Exiting."
            exit 1 
          fi
