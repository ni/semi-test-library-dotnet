name:
    PR_Build

on:
    workflow_run:
        workflows: ["PR_Intake"]
        types:
            - requested
            - completed
        branches: 
            - main
            - 'releases/**'
            - 'users/tanish/**'

permissions:
    actions: write
    contents: write
    pull-requests: write

# As I am sure that this workflow will be triggered by PR_Intake workflow, I can safely assume that the first PR in the list is the one I am interested in.
run-name: "PR Build #${{ github.event.workflow_run.pull_requests[0].number }}"

env:
    GITHUB_MixedSignalTestLibrary_BRANCH_NAME: '{"GITHUB_MixedSignalTestLibrary_BRANCH_NAME": "${{ github.event.workflow_run.pull_requests[0].head.ref }}"}'

jobs:
    build:   
        name: Call Azure Pre Build Pipeline
        runs-on: ubuntu-latest
        environment: gh-action-testing
        steps:
        - uses: actions/checkout@v2
        - name: Trigger Azure Pipeline for Pre Build
          uses: enfa/azure-pipeline-github-action@v1.0.0
          with:
            azure-devops-project-url: https://ni.visualstudio.com/DevCentral
            azure-pipeline-name: 'MixedSignalLibrary_PR_GitHub'
            azure-devops-token: ${{ secrets.AZURE_DEVOPS_TOKEN }}
            azure-pipeline-variables:  ${{ env.GITHUB_MixedSignalTestLibrary_BRANCH_NAME }}
            azure-pipeline-sourcebranch: "refs/heads/${{ github.base_ref }}"

# Give the run name such that it incluides PR number
# Then in PR Intake check the status of this run and if it is successful, then merge the PR. (Using github api and github token)
# Use fined grained token with only read-only permission to actions (if required).