name: pr-build

on:
    workflow_run:
        workflows: ["pr-intake"]
        types:
            - in_progress

run-name: "PR Build for pr-intake #${{ github.event.workflow_run.run_number }}"

env:
    GITHUB_MixedSignalTestLibrary_REPO_OWNER: ${{ github.event.workflow_run.head_repository.owner.login }}
    GITHUB_MixedSignalTestLibrary_REPO_NAME: ${{ github.event.workflow_run.head_repository.name }}
    GITHUB_MixedSignalTestLibrary_BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}

jobs:
    build:   
        name: Call Azure Pre Build Pipeline
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2

        - name: Check triggering workflow status
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            RUN_ID=${{ github.event.workflow_run.id }}
            REPO=${{ github.repository }}
            STATUS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID" | jq -r '.conclusion')
            echo "Triggering workflow conclusion: $STATUS"
            if [[ "$STATUS" == "failure" || "$STATUS" == "cancelled" ]]; then
              echo "Triggering workflow failed or was cancelled. Exiting."
              exit 1
            fi

        - name: Trigger MixedSignalLibrary_PR_GitHub Azure Pipeline for Pre Build
          id: trigger_pipeline
          run: |
            ORG="ni"
            PROJECT="DevCentral"
            PIPELINE_ID="22120"
            BRANCH="main"
            PAT="${{ secrets.AZURE_DEVOPS_TOKEN }}"

            REPO_OWNER="${{ env.GITHUB_MixedSignalTestLibrary_REPO_OWNER }}"
            REPO_NAME="${{ env.GITHUB_MixedSignalTestLibrary_REPO_NAME }}"
            BRANCH_NAME="${{ env.GITHUB_MixedSignalTestLibrary_BRANCH_NAME }}"

            BODY=$(jq -n \
              --arg ref "refs/heads/$BRANCH" \
              --arg owner "$REPO_OWNER" \
              --arg repo "$REPO_NAME" \
              --arg branch "$BRANCH_NAME" \
              '{
                resources: {
                  repositories: {
                    self: {
                      refName: $ref
                    }
                  }
                },
                variables: {
                  GITHUB_MixedSignalTestLibrary_REPO_OWNER: { value: $owner },
                  GITHUB_MixedSignalTestLibrary_REPO_NAME: { value: $repo },
                  GITHUB_MixedSignalTestLibrary_BRANCH_NAME: { value: $branch }
                }
              }')

            RESPONSE=$(curl -sS -X POST \
              -u ":$PAT" \
              -H "Content-Type: application/json" \
              -d "$BODY" \
              "https://dev.azure.com/$ORG/$PROJECT/_apis/pipelines/$PIPELINE_ID/runs?api-version=7.0")

            echo "Response: $RESPONSE"
            BUILD_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
              echo "Failed to trigger Azure DevOps pipeline"
              exit 1
            fi

            PIPELINE_URL="https://dev.azure.com/$ORG/$PROJECT/_build/results?buildId=$BUILD_ID"
            echo "Azure DevOps pipeline triggered: $PIPELINE_URL"

            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

        - name: Wait for Pipeline to Complete
          id: wait_pipeline
          run: |
            BUILD_ID="${{ steps.trigger_pipeline.outputs.build_id }}"
            ORG="ni"
            PROJECT="DevCentral"
            PAT="${{ secrets.AZURE_DEVOPS_TOKEN }}"

            TIMEOUT=1200   # 20 minutes
            INTERVAL=30    # check every 30 seconds
            ELAPSED=0
            STATUS="inProgress"

            while [ "$STATUS" = "inProgress" ] || [ "$STATUS" = "notStarted" ]; do
              if [[ "$ELAPSED" -ge "$TIMEOUT" ]]; then
                echo "::error ::Timeout reached after 20 minutes while waiting for Azure DevOps pipeline to complete."
                exit 1
              fi

              RESPONSE=$(curl -sS -u ":$PAT" \
                "https://dev.azure.com/$ORG/$PROJECT/_apis/build/builds/$BUILD_ID?api-version=6.0")
              STATUS=$(echo "$RESPONSE" | jq -r '.status')
              echo "Current build status: $STATUS"

              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            RESULT=$(echo "$RESPONSE" | jq -r '.result')
            echo "Build result: $RESULT"
            if [ "$RESULT" != "succeeded" ]; then
              exit 1
            fi
